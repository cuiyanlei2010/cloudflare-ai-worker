<!DOCTYPE html>
<html lang="en">
<head>
<title>GPT</title>
<link rel="shortcut icon" href="#"/>
<style type="text/css">
html,body{height:100%}body{background-color:rgba(68,70,84,1.0);display:flex;flex-direction:column;justify-content:space-between;margin:0}select{max-width:100%;text-overflow:ellipsis}#response-list{border:none;overflow-y:auto;flex:1}#response-list .response-container{margin-bottom:10px;color:white;font-size:1rem;display:flex;word-break:break-word}#response-list .response-container,#bottom-container{padding:15px 10%}@media (pointer:none),(pointer:coarse){#response-list .response-container,#bottom-container{padding:15px}.ai-image{max-width:100%}}#response-list .response-container .avatar-image{width:30px;height:30px;margin-right:15px}#response-list .response-container .response-content{display:flex;flex-direction:column}#response-list .response-container pre{max-width:100%;margin:0 !important;white-space:break-spaces}#response-list .response-container .prompt-content{background:transparent !important;color:white;padding:0 !important}#response-list .response-container .prompt-content *{white-space:pre-wrap}#response-list .response-container .prompt-content p:first-child{margin-top:0}.chatgpt-response{background-color:rgba(68,70,84,1)}.my-question{background-color:rgba(52,53,65,1)}#input-container{display:flex;align-items:center;justify-content:space-between;padding:10px;background-color:rgba(64,65,79,1);border-color:rgba(32,33,35,.5);border-radius:5px;margin-top:10px}#prompt-input{flex-grow:1;padding:10px;border-radius:5px;min-height:20px;color:white;overflow:auto}#prompt-input:focus{outline:none !important}#submit-button{background:transparent url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><path fill='white' d='M2.01 21L23 12 2.01 3 2 10l15 2-15 2z'/></svg>") no-repeat center center;color:white;width:40px;height:40px;border:none;border-radius:5px;cursor:pointer}#regenerate-button-container{display:flex;flex-direction:row;justify-content:center;margin-bottom:10px}#regenerate-response-button{display:none;color:white;border:none;background:#10A37F;border-radius:4px;padding:10px 20px;cursor:pointer}.loading{opacity:0.5;cursor:not-allowed;pointer-events:none}#model-select-container{color:white}#model-select-container select{background:transparent;border:none;outline:none;color:white}#model-select-container select option:not(:checked){background:rgba(32,33,35,.8)}#model-select-container select option{background:rgba(32,33,35,.5)}.ai-image{width:500px;height:auto}.hljs{background:rgb(0,0,0) !important;color:white !important}.hljs-section,.hljs-title{color:#f22c3d !important}.hljs-deletion,.hljs-number,.hljs-quote,.hljs-selector-class,.hljs-selector-id,.hljs-string,.hljs-template-tag,.hljs-type{color:#df3079 !important}.hljs-addition,.hljs-built_in,.hljs-bullet,.hljs-code{color:#e9950c !important}.hljs-link,.hljs-operator,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:white !important}
.GPT-icon {font-weight: bold;color: #00B4D9;white-space: nowrap;}
.User-icon {font-weight: bold;white-space: nowrap;}
.common-button {color: white;border: none;background: #10A37F;border-radius: 4px;padding: 10px 20px;cursor: pointer;}
</style>
<link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/11.7.0/styles/default.min.css">
<meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
<div id="response-list">
</div>
<div id="bottom-container">
    <div id="regenerate-button-container">
        <button id="regenerate-response-button">
            Regenerate Response
        </button>
    </div>
    <button id="clear-button" class="common-button">Clear</button>
    <div id="model-select-container">
        <label for="model-select">Select model:</label>
        <select id="model-select">
            <option value="gpt-3.5-turbo" selected>gpt-3.5-turbo</option>
            <option value="gpt-3.5-turbo-16k">gpt-3.5-turbo-16k</option>
        </select>
    </div>
    <div id="input-container">
        <div id="prompt-input" contentEditable></div>
        <button id="submit-button"></button>
    </div>
</div>
<script src="https://cdn.staticfile.org/highlight.js/11.7.0/highlight.min.js"></script>
<script src="https://cdn.staticfile.org/showdown/2.1.0/showdown.min.js"></script>
<script type="text/javascript">
const API_URL = '/';
const converter = new showdown.Converter();
let promptToRetry = null;
let uniqueIdToRetry = null;
function Counter(){
    this.val = 0;
}
const counter = new Counter();
sessionStorage.clear();
const submitButton = document.getElementById('submit-button');
const regenerateResponseButton = document.getElementById('regenerate-response-button');
const promptInput = document.getElementById('prompt-input');
const modelSelect = document.getElementById('model-select');
const responseList = document.getElementById('response-list');

let isGeneratingResponse = false;
let loadInterval = null;
function generateUniqueId() {
    const timestamp = Date.now();
    const randomNumber = Math.random();
    const hexadecimalString = randomNumber.toString(16);
    return `id-${timestamp}-${hexadecimalString}`;
}

function addResponse(selfFlag, prompt) {
    const uniqueId = generateUniqueId();
    const html = `
            <div class="response-container ${selfFlag ? 'my-question' : 'chatgpt-response'}">
                <div class="${selfFlag ? 'User' : 'GPT'}-icon">${selfFlag ? 'User' : 'GPT'}: </div>
                <div class="prompt-content" id="${uniqueId}">${prompt}</div>
            </div>
        `
    responseList.insertAdjacentHTML('beforeend', html);
    responseList.scrollTop = responseList.scrollHeight;
    return uniqueId;
}

function loader(element) {
    element.textContent = ''

    loadInterval = setInterval(() => {
        element.textContent += '.';
        if (element.textContent === '....') {
            element.textContent = '';
        }
    }, 300);
}

function setErrorForResponse(element, message) {
    element.innerHTML = message;
    element.style.color = 'rgb(200, 0, 0)';
}

function setRetryResponse(prompt, uniqueId) {
    promptToRetry = prompt;
    uniqueIdToRetry = uniqueId;
    regenerateResponseButton.style.display = 'flex';
}

async function regenerateGPTResult() {
    try {
        await getGPTResult(promptToRetry, uniqueIdToRetry)
        regenerateResponseButton.classList.add("loading");
    } finally {
        regenerateResponseButton.classList.remove("loading");
    }
}

async function getGPTResult(_promptToRetry, _uniqueIdToRetry) {
    const prompt = _promptToRetry ?? promptInput.textContent;
    if (isGeneratingResponse || !prompt) {
        return;
    }
    submitButton.classList.add("loading");
    promptInput.textContent = '';

    if (!_uniqueIdToRetry) {
        addResponse(true, `<div>${prompt}</div>`);
    }
    const uniqueId = _uniqueIdToRetry ?? addResponse(false);
    const responseElement = document.getElementById(uniqueId);
    loader(responseElement);
    isGeneratingResponse = true;
    let jsonString = JSON.stringify({
        role:"user",
        content:prompt
    })
    saveConversation(jsonString)
    let integerKeys = [];
    let messages= [];
    for (let i = 0; i < counter.val; i++) {
        messages.push(JSON.parse(sessionStorage.getItem(i)));
    }
    try {
        const model = modelSelect.value;
        const response = await fetch(API_URL + 'api', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                messages,
                model
            })
        });
        if (!response.ok) {
            setRetryResponse(prompt, uniqueId);
            setErrorForResponse(responseElement, `HTTP Error: ${await response.text()}`);
            return;
        }
        const responseText = await response.text();
        let jsonString = JSON.stringify({
            role:"assistant",
            content:responseText
        })
        saveConversation(jsonString)
        responseElement.innerHTML = converter.makeHtml(responseText.trim());
        promptToRetry = null;
        uniqueIdToRetry = null;
        regenerateResponseButton.style.display = 'none';
        setTimeout(() => {
            responseList.scrollTop = responseList.scrollHeight;
            hljs.highlightAll();
        }, 10);
    } catch (err) {
        setRetryResponse(prompt, uniqueId);
        setErrorForResponse(responseElement, `Error: ${err.message}`);
    } finally {
        isGeneratingResponse = false;
        submitButton.classList.remove("loading");
        clearInterval(loadInterval);
    }
}
submitButton.addEventListener("click", () => {
    getGPTResult();
});
regenerateResponseButton.addEventListener("click", () => {
    regenerateGPTResult();
});
document.addEventListener("DOMContentLoaded", function(){
    promptInput.focus();
});
function saveConversation(json){
    sessionStorage.setItem(counter.val, json)
    counter.val += 1;
}
const clearButton = document.getElementById('clear-button');
clearButton.addEventListener('click', () => {
  sessionStorage.clear();
  counter.val = 0;
  responseList.innerHTML = '';
});
</script>
</body>
</html>
